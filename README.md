**Работа сервиса приема и обработки платежей от терминала.**

Для входяших запросов реализован ``QiwiController``, у которого есть два метода.Первый принимает запросы на проверку клиента 
и возможность проводить операции с валютой которая передается в запросе(check).Второй принимает запросы на подтверждение платежа(pay).

Сервис термина отправляет запрос в таком виде =>

### ################### CHECK ################### ###

GET /payment_app.cgi?command=check&txn_id=1234567&
account=4957835959&sum=10.45&ccy=RUB HTTP/1.1

Запрос содержит параметры:

* command=check – идентификатор запроса на проверку состояния абонента;
* txn_id=1234567 – внутренний номер платежа в системе Visa QIWI Wallet;
* account=4957835959 – идентификатор абонента в информационной системе провайдера;
* sum=10.45 – сумма к зачислению на лицевой счет абонента;
* ccy=RUB – валюта суммы зачисления на лицевой счет абонента.

#### ################### PAY ########################### ####

GET /payment_app.cgi?command=pay&txn_id=1234567&
txn_date=20110815120133&account=4957835959&sum=10.45&ccy=RUB HTTP/1.1

Запрос содержит параметры:

* command=pay – идентификатор запроса на пополнение баланса абонента;
* txn_id=1234567 – внутренний номер платежа в системе Visa QIWI Wallet;
* txn_date=20090815120133 – дата учета платежа в системе Visa QIWI Wallet;
* account=4957835959 – идентификатор абонента в информационной системе провайдера;
* sum=10.45	– сумма к зачислению на лицевой счет абонента;
* ccy=RUB – валюта суммы зачисления на лицевой счет абонента.


Для обработки и процессинга операций реализован ``QiwiPaymentTerminalService``.

В методе ``checkClientAndMakePayment()`` выполняется логика попроверке пользователя.
В методе ``checkInternal()`` мы отправлям запрос в авторизационный сервис и проверяем есть ли пользователь с таким email,
если пользователь не найден то кидаем ошибку и отправляем в ответе сервису терминала ``<result>1</result>``.
Если пользователь с таким email есть, то создаем ID платежа в нашей системе в методе ``generatePaymentId()``, заполняем объект Payment
и сохраняем его в БД.По дефолту присваивается статус *PENDING*. Сервису теминала отправляем ответ в xml формате и нужно передавать
``<result>0</result>`` , где `0` означает положительный ответ.

В методе ``confirmPayment()`` выполняется логика по проверке подтверждения платежа.Необходимо проверить входящие параметры метода
с данными в БД,проверка происходит в методе ``checkPayment()``. Если платежа с таким ``txn_id`` нет в системе или входящие данные 
отличаются от данных в БД то кидаем ошибку и возвращаем сервису терминала код ошибки в теге ``<result>5</result>``.
Если проверка прошла положительно,то делаем update платежа в БД (меняем статус на *PROCESSED*, добавляем дату платежа) и 
отправляем ответ сервису терминала в формате xml с кодом ``<result>0</result>``.

